<!DOCTYPE html>
<html lang="en">
  <head>
      <title>andy reagan</title>
    <meta charset="utf-8" />
    <META HTTP-EQUIV="CACHE-CONTROL" CONTENT="NO-CACHE">




    <link rel="stylesheet" type="text/css" href="/theme/css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="/theme/css/beemuse.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/theme/css/base.css">
    <!-- <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/styles/default.min.css"> -->
    <!-- <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/highlight.min.js"></script> -->
  </head>
  <body>

    <section id="navbar">
	  <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
	    <div class="container">
              <div class="navbar-header">
		<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
		  <span class="sr-only">Toggle navigation</span>
		  <span class="icon-bar"></span>
		  <span class="icon-bar"></span>
		  <span class="icon-bar"></span>
		</button>
		<a class="navbar-brand" href="/index.html">andyreagan.com</a>
              </div>
              <div class="collapse navbar-collapse">
		<ul class="nav navbar-nav">
		  <li ><a href="/pages/blog.html">Blog</a></li>
		  <li ><a href="/pages/about-me.html">About</a></li>
		  <li ><a href="/pages/cv.html">CV</a></li>
		  <li ><a href="/pages/publications.html">Publications</a></li>
		  <li ><a href="/pages/teaching.html">Teaching</a></li>
		  <li ><a href="/pages/visualizations.html">Visualizations</a></li>
		</ul>
              </div><!--/.nav-collapse -->
	    </div>
	  </div>
    </section>

    <br>
<section class="content">
  <div class="row">
    
    <div class="col-xs-12 col-md-8  col-md-offset-2 col-lg-6 col-lg-offset-3">
      <div class="paper">
  <header>
    <h2 class="entry-title">
      <a href="/2020/01/08/column-level-encryption-on-a-vertica-database/" rel="bookmark"
         title="Permalink to Column level encryption on a Vertica Database">Column level encryption on a Vertica Database</a></h2>
 
  </header>
  <footer class="post-info">
    <abbr class="published" title="2020-01-08T00:00:00+01:00">
      Wed 08 January 2020
    </abbr>
  </footer><!-- /.post-info -->
  <br>
  <div class="entry-content">
    <p>Vertica is a very powerful analytics database,
and security is very important to us at MassMutual.
There are cases where we need to store sensitive data,
like SSN,
but we don't want the SSNs available to anyone who can see the table in Vertica.
To provide an additional layer of security,
we can encrypt the SSN itself and store the encrypted data.</p>
<p>We can easily extend Vertica functionality now by building in Python functions,
so we'll do this in Python.
To get set up developing with Python for Vertica,
see my <a href="https://andyreagan.github.io/2019/07/05/developing-python-on-vertica/">previous post</a>.</p>
<p>There are many different algorithms around,
here we'll choose RSA.
If you're not familiar with RSA,
all you really need to know is that there are two keys:
(1) used to encrypt data (in RSA parlance, the public key)
and (2) use to decrypt the data (the private key).
The cryptography relies on a hard problem one way (factoring a multiple of two large primes),
that is very easy the other way (creating that number if you have both primes: you just multiply).</p>
<p>Example: we have SSN data <code>111-22-3333</code>.
Using an encryption key of <code>30820122300d0...</code> (it's 512 characters of this),
we'll turn <code>111-22-3333</code> into a long string of letters and numbers.
We could use the decryption key on that long string to get back the original SSN.</p>
<h2>Create the encryption script in Python</h2>
<p>Using the <code>pycrypto</code> library, here's how we can construct a simple encryption script:</p>
<div class="highlight"><pre><span></span><span class="c1"># encrypt_lambda.py</span>

<span class="kn">from</span> <span class="nn">Crypto.PublicKey</span> <span class="kn">import</span> <span class="n">RSA</span>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">key</span> <span class="o">=</span> <span class="n">RSA</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">2048</span><span class="p">)</span>
<span class="n">binPrivKey</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">exportKey</span><span class="p">(</span><span class="s1">&#39;DER&#39;</span><span class="p">)</span>
<span class="n">binPubKey</span> <span class="o">=</span>  <span class="n">key</span><span class="o">.</span><span class="n">publickey</span><span class="p">()</span><span class="o">.</span><span class="n">exportKey</span><span class="p">(</span><span class="s1">&#39;DER&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">bin2hex</span><span class="p">(</span><span class="n">binStr</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">binStr</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">hex2bin</span><span class="p">(</span><span class="n">hexStr</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">hexStr</span><span class="p">)</span>


<span class="n">x</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">key</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="n">bin2hex</span><span class="p">(</span><span class="n">RSA</span><span class="o">.</span><span class="n">importKey</span><span class="p">(</span><span class="n">hex2bin</span><span class="p">(</span><span class="n">key</span><span class="p">))</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">),</span> <span class="mi">10</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>


<p>We can test this by first installing <code>pycrypto</code>, then:</p>
<div class="highlight"><pre><span></span>python3 encrypt_lambda.py 30820122300d06092a864886f70d01010105000382010f003082010a0282010100df91d2e51370d260a25dbc0121ce0c999f0a0896f8e44c04b6d331be91fa74a7c51bf4c7dfa49835a18116520a685d6e314dfbd047dcdf999ffcfda3770dfb24776a0dda94d6795c517c9c304a3da893a837371811a64f66bcb743d40fbb2aba4701c5f4a536b740773d672db5ec48a538cda7bebda8dc3161a14cb26e371fb9eacf5f50cf7626d5d84daf7a34d3b2bdab336d89ff640afaced9c29aa86007b7da10db05c0298e84f4662663941dbe8bbe6a18732bb0ee4af1ac561b0e47f2beefe22a4179bada94d3fb154b4cfeca29eef5b8bf1198cd11167918de5cf3c2e30c2eabdee953f6d49804f441d29a9cbaa4553c08711afe14d624a200a2b30d8d0203010001 111223333
6d0eb35fd82302731c5649773b873e3a714c14af356f8dba6b07fc8ba3c1aa9fcd9b041dfb4c359574433bc0d38a14ab12f211ad1a2ef069a791b6dee006405af9e97f1012abf0458f2ae7f4557278bce4444c2a86491d304dedf63f4328ff14e53232bd64c4174a85cb9b52d00f285df80328686c10b67634424984f47d23803ceef9ddae1ab782b4816bb935e0cf28ae2dc9e76453610a3d62a0b6261703e8f6fa8100f310758a472331b8cb76024a59f93b887a8a3f9b6e4ddbcc650f8d42c2ef17f09209e7d2d007c9688a538052520c9578c5e70c7ef0479490d27f250e2915afb1e08674587bf63679651cc67ee973593f51f5d4157644d3a8ab9f14eb
</pre></div>


<p>For Vertica, we have to create the sdk classes,
name this one <code>rsa.py</code>:</p>
<div class="highlight"><pre><span></span><span class="c1"># rsa.py</span>
<span class="kn">from</span> <span class="nn">Crypto.PublicKey</span> <span class="kn">import</span> <span class="n">RSA</span>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">import</span> <span class="nn">vertica_sdk</span>


<span class="k">def</span> <span class="nf">bin2hex</span><span class="p">(</span><span class="n">binStr</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">binStr</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">hex2bin</span><span class="p">(</span><span class="n">hexStr</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">hexStr</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">encrypt</span><span class="p">(</span><span class="n">vertica_sdk</span><span class="o">.</span><span class="n">ScalarFunction</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Very simple scalar function which adds its two integer inputs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">processBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_interface</span><span class="p">,</span> <span class="n">arg_reader</span><span class="p">,</span> <span class="n">res_writer</span><span class="p">):</span>
        <span class="n">server_interface</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Hello! python_udxes_are_great&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">arg_reader</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># get the second argument</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">arg_reader</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">bin2hex</span><span class="p">(</span><span class="n">RSA</span><span class="o">.</span><span class="n">importKey</span><span class="p">(</span><span class="n">hex2bin</span><span class="p">(</span><span class="n">key</span><span class="p">))</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">),</span> <span class="mi">10</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
            <span class="n">res_writer</span><span class="o">.</span><span class="n">setString</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">res_writer</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">arg_reader</span><span class="o">.</span><span class="n">next</span><span class="p">():</span>
                <span class="k">break</span>


<span class="k">class</span> <span class="nc">encrypt_factory</span><span class="p">(</span><span class="n">vertica_sdk</span><span class="o">.</span><span class="n">ScalarFunctionFactory</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">getPrototype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">srv_interface</span><span class="p">,</span> <span class="n">arg_types</span><span class="p">,</span> <span class="n">return_type</span><span class="p">):</span>
        <span class="n">arg_types</span><span class="o">.</span><span class="n">addVarchar</span><span class="p">()</span>
        <span class="c1"># add a second argument</span>
        <span class="n">arg_types</span><span class="o">.</span><span class="n">addVarchar</span><span class="p">()</span>
        <span class="n">return_type</span><span class="o">.</span><span class="n">addVarchar</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">getReturnType</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">srv_interface</span><span class="p">,</span> <span class="n">arg_types</span><span class="p">,</span> <span class="n">return_type</span><span class="p">):</span>
            <span class="n">return_type</span><span class="o">.</span><span class="n">addVarchar</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">createScalarFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">srv</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">encrypt</span><span class="p">()</span>
</pre></div>


<h2>Deploy it on Vertica</h2>
<p>Then we create the function on Vertica, using the SDK-friendly script above.</p>
<div class="highlight"><pre><span></span>\set libfile &#39;\&#39;&#39;`pwd`&#39;/rsa.py\&#39;&#39;
DROP LIBRARY rsalib CASCADE;
CREATE LIBRARY rsalib AS :libfile DEPENDS &#39;/home/dbadmin/local/lib/python3.5/site-packages/&#39; LANGUAGE &#39;Python&#39;;

-- Step 2: Create functions
CREATE FUNCTION encrypt AS NAME &#39;encrypt_factory&#39; LIBRARY rsalib;
</pre></div>


<p>We can test the function directly:</p>
<div class="highlight"><pre><span></span>select encrypt(&#39;30820122300d06092a864886f70d01010105000382010f003082010a0282010100df91d2e51370d260a25dbc0121ce0c999f0a0896f8e44c04b6d331be91fa74a7c51bf4c7dfa49835a18116520a685d6e314dfbd047dcdf999ffcfda3770dfb24776a0dda94d6795c517c9c304a3da893a837371811a64f66bcb743d40fbb2aba4701c5f4a536b740773d672db5ec48a538cda7bebda8dc3161a14cb26e371fb9eacf5f50cf7626d5d84daf7a34d3b2bdab336d89ff640afaced9c29aa86007b7da10db05c0298e84f4662663941dbe8bbe6a18732bb0ee4af1ac561b0e47f2beefe22a4179bada94d3fb154b4cfeca29eef5b8bf1198cd11167918de5cf3c2e30c2eabdee953f6d49804f441d29a9cbaa4553c08711afe14d624a200a2b30d8d0203010001&#39;, &#39;111-53-8888&#39;);
</pre></div>


<p>You can also store keys in a table:</p>
<div class="highlight"><pre><span></span>create table public_keys (name varchar(80), key varchar(1024));
insert into public_keys (name, key) (select &#39;andys key&#39;, &#39;30820122300d06092a864886f70d01010105000382010f003082010a0282010100df91d2e51370d260a25dbc0121ce0c999f0a0896f8e44c04b6d331be91fa74a7c51bf4c7dfa49835a18116520a685d6e314dfbd047dcdf999ffcfda3770dfb24776a0dda94d6795c517c9c304a3da893a837371811a64f66bcb743d40fbb2aba4701c5f4a536b740773d672db5ec48a538cda7bebda8dc3161a14cb26e371fb9eacf5f50cf7626d5d84daf7a34d3b2bdab336d89ff640afaced9c29aa86007b7da10db05c0298e84f4662663941dbe8bbe6a18732bb0ee4af1ac561b0e47f2beefe22a4179bada94d3fb154b4cfeca29eef5b8bf1198cd11167918de5cf3c2e30c2eabdee953f6d49804f441d29a9cbaa4553c08711afe14d624a200a2b30d8d0203010001&#39;);
select encrypt(pk.key, secrets.ssn) as encrypted_ssn from (select &#39;111-53-8888&#39; as ssn) secrets full outer join public_keys pk on pk.name = &#39;andys key&#39;;
</pre></div>


<p>Now we can sleep better knowing that the data is just a little bit safer!</p>
<p>I'll leave the decryption up to you,
it should be simple now ;)</p>
  </div><!-- /.entry-content -->
      </div>
      </div>      
 </section><!-- /#content -->

    <footer id="slidingfooter" class="body">
      Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>. Site design by Andy Reagan.
    </footer><!-- /#contentinfo -->
  </body>
</script>
</html>