<!DOCTYPE html>
<html lang="en">
  <head>
      <title>andy reagan</title>
    <meta charset="utf-8" />
    <META HTTP-EQUIV="CACHE-CONTROL" CONTENT="NO-CACHE">




    <link rel="stylesheet" type="text/css" href="/theme/css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="/theme/css/beemuse.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/theme/css/base.css">
    <!-- <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/styles/default.min.css"> -->
    <!-- <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/highlight.min.js"></script> -->
  </head>
  <body>

    <section id="navbar">
	  <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
	    <div class="container">
              <div class="navbar-header">
		<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
		  <span class="sr-only">Toggle navigation</span>
		  <span class="icon-bar"></span>
		  <span class="icon-bar"></span>
		  <span class="icon-bar"></span>
		</button>
		<a class="navbar-brand" href="/index.html">andyreagan.com</a>
              </div>
              <div class="collapse navbar-collapse">
		<ul class="nav navbar-nav">
		  <li ><a href="/pages/blog.html">Blog</a></li>
		  <li ><a href="/pages/about-me.html">About</a></li>
		  <li ><a href="/pages/cv.html">CV</a></li>
		  <li ><a href="/pages/publications.html">Publications</a></li>
		  <li ><a href="/pages/teaching.html">Teaching</a></li>
		  <li ><a href="/pages/visualizations.html">Visualizations</a></li>
		</ul>
              </div><!--/.nav-collapse -->
	    </div>
	  </div>
    </section>

    <br>
<section class="content">
  <div class="row">
    
    <div class="col-xs-12 col-md-8  col-md-offset-2 col-lg-6 col-lg-offset-3">
      <div class="paper">
  <header>
    <h2 class="entry-title">
      <a href="/2017/05/04/should-i-set-metadata-manually-in-pyspark/" rel="bookmark"
         title="Permalink to Should I set metadata manually in pyspark?">Should I set metadata manually in pyspark?</a></h2>
 
  </header>
  <footer class="post-info">
    <abbr class="published" title="2017-05-04T00:00:00+02:00">
      Thu 04 May 2017
    </abbr>
  </footer><!-- /.post-info -->
  <br>
  <div class="entry-content">
    <p>Well, let’s do a simple test and find out if it speeds up the process of one-hot encoding a variable in our data. There are other reasons to set it, and we’ll get to those. Starting with the very helpful code snippet from <a href="https://github.com/awesome-spark/spark-gotchas/blob/master/06_data_preparation.md">spark-gotchas</a>:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">pyspark</span> <span class="kn">import</span> <span class="n">SparkContext</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">Column</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span>

<span class="k">def</span> <span class="nf">withMeta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">meta</span><span class="p">):</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">SparkContext</span><span class="o">.</span><span class="n">_active_spark_context</span>
    <span class="n">jmeta</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">_gateway</span><span class="o">.</span><span class="n">jvm</span><span class="o">.</span><span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">Metadata</span>
    <span class="k">return</span> <span class="n">Column</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jc</span><span class="p">,</span> <span class="s2">&quot;as&quot;</span><span class="p">)(</span><span class="n">alias</span><span class="p">,</span> <span class="n">jmeta</span><span class="o">.</span><span class="n">fromJson</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">meta</span><span class="p">))))</span>

<span class="n">Column</span><span class="o">.</span><span class="n">withMeta</span> <span class="o">=</span> <span class="n">withMeta</span>


<span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ml_attr&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;label_with_meta&quot;</span><span class="p">,</span>
  <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;nominal&quot;</span><span class="p">,</span>
  <span class="s2">&quot;vals&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0.0&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span> <span class="s2">&quot;2.0&quot;</span><span class="p">]}}</span>


<span class="n">df_with_meta</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;label_with_meta&quot;</span><span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">withMeta</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">meta</span><span class="p">))</span>
<span class="n">df_with_meta</span><span class="o">.</span><span class="n">schema</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">metadata</span> <span class="o">==</span> <span class="n">meta</span>

<span class="c1">## True</span>
</pre></div>


<p>First, I will write functions to do a one hot encoding with and without metadata. Without metadata:</p>
<div class="highlight"><pre><span></span>def testWithoutMetadata(df):
    OHEncoder = OneHotEncoder(inputCol=&quot;label&quot;,
                              outputCol=&quot;label_OH&quot;)

    df_transformed = OHEncoder.transform(df)
</pre></div>


<p>And with metadata:</p>
<div class="highlight"><pre><span></span>def testMetadata(df):
    meta = {&quot;ml_attr&quot;: {&quot;name&quot;: &quot;label_with_meta&quot;,
      &quot;type&quot;: &quot;nominal&quot;,
      &quot;vals&quot;: [&quot;0&quot;,&quot;1&quot;,&quot;2&quot;]}}
    OHEncoderMeta = OneHotEncoder(inputCol=&quot;label_with_meta&quot;,
                                  outputCol=&quot;label_OH_with_meta&quot;)

    df_with_meta = df.withColumn(&quot;label_with_meta&quot;,                    
                                 col(&quot;label&quot;).withMeta(&quot;&quot;, meta))
    df_with_meta_transformed = OHEncoderMeta.transform(df_with_meta)
</pre></div>


<p>You can see how in the above, I used the withMeta function from above.
Now, the tests:</p>
<div class="highlight"><pre><span></span><span class="c">%%timeit -n 5 -r 5</span>
<span class="nb">size</span> <span class="p">=</span> <span class="mi">100000</span>
<span class="n">df</span> <span class="p">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">list</span><span class="p">(</span><span class="n">zip</span><span class="p">(</span><span class="n">map</span><span class="p">(</span><span class="n">int</span><span class="p">,</span><span class="n">np</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">size</span><span class="p">)),</span><span class="n">map</span><span class="p">(</span><span class="n">int</span><span class="p">,</span><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="nb">size</span><span class="p">)))),[</span>&quot;<span class="n">id</span>&quot;<span class="p">,</span> &quot;<span class="n">label</span>&quot;<span class="p">])</span>
<span class="n">testWithoutMetadata</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>


<p>and</p>
<div class="highlight"><pre><span></span><span class="c">%%timeit -n 5 -r 5</span>
<span class="nb">size</span> <span class="p">=</span> <span class="mi">100000</span>
<span class="n">df</span> <span class="p">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">list</span><span class="p">(</span><span class="n">zip</span><span class="p">(</span><span class="n">map</span><span class="p">(</span><span class="n">int</span><span class="p">,</span><span class="n">np</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">size</span><span class="p">)),</span><span class="n">map</span><span class="p">(</span><span class="n">int</span><span class="p">,</span><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="nb">size</span><span class="p">)))),[</span>&quot;<span class="n">id</span>&quot;<span class="p">,</span> &quot;<span class="n">label</span>&quot;<span class="p">])</span>
<span class="n">testMetadata</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>


<p>The speed difference for 100,000 data points: 4.66s to 4.16s. A half second speedup on a single executor. In essence, this amounts to how long it too spark to look up the range on the column for which we didn’t provide metadata (check the scala). Was it worth it? Probably not.</p>
<p>Onward!</p>
<p>Final note — there are still likely to be cases where the metadata is useful to spark, such as:
1. Avoiding using a stringIndexer, which is quite a bit slower than the one-hot encoder.
2. Providing the variable type to a classification method such as a Random Forest, which can take advantage of variable types.
3. Doing a one-hot encoding where the full range of values is not included in the training set. You can pass the known full range in as metadata, and your pipeline will reflect this.</p>
  </div><!-- /.entry-content -->
      </div>
      </div>      
 </section><!-- /#content -->

    <footer id="slidingfooter" class="body">
      Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>. Site design by Andy Reagan.
    </footer><!-- /#contentinfo -->
  </body>
</script>
</html>