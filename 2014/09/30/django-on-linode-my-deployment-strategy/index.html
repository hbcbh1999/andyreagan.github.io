<!DOCTYPE html>
<html lang="en">
  <head>
      <title>andy reagan</title>
    <meta charset="utf-8" />
    <META HTTP-EQUIV="CACHE-CONTROL" CONTENT="NO-CACHE">




    <link rel="stylesheet" type="text/css" href="/theme/css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="/theme/css/beemuse.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/theme/css/base.css">
    <!-- <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/styles/default.min.css"> -->
    <!-- <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/highlight.min.js"></script> -->
  </head>
  <body>

    <section id="navbar">
	  <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
	    <div class="container">
              <div class="navbar-header">
		<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
		  <span class="sr-only">Toggle navigation</span>
		  <span class="icon-bar"></span>
		  <span class="icon-bar"></span>
		  <span class="icon-bar"></span>
		</button>
		<a class="navbar-brand" href="/index.html">andyreagan.com</a>
              </div>
              <div class="collapse navbar-collapse">
		<ul class="nav navbar-nav">
		  <li ><a href="/pages/blog.html">Blog</a></li>
		  <li ><a href="/pages/about-me.html">About</a></li>
		  <li ><a href="/pages/cv.html">CV</a></li>
		  <li ><a href="/pages/publications.html">Publications</a></li>
		  <li ><a href="/pages/teaching.html">Teaching</a></li>
		  <li ><a href="/pages/visualizations.html">Visualizations</a></li>
		</ul>
              </div><!--/.nav-collapse -->
	    </div>
	  </div>
    </section>

    <br>
<section class="content">
  <div class="row">
    
    <div class="col-xs-12 col-md-8  col-md-offset-2 col-lg-6 col-lg-offset-3">
      <div class="paper">
  <header>
    <h2 class="entry-title">
      <a href="/2014/09/30/django-on-linode-my-deployment-strategy/" rel="bookmark"
         title="Permalink to Django on Linode: My Deployment Strategy">Django on Linode: My Deployment Strategy</a></h2>
 
  </header>
  <footer class="post-info">
    <abbr class="published" title="2014-09-30T00:00:00+02:00">
      Tue 30 September 2014
    </abbr>
    <abbr class="modified" title="2014-10-06T00:00:00+02:00">
      Mon 06 October 2014
    </abbr>
  </footer><!-- /.post-info -->
  <br>
  <div class="entry-content">
    <p>Over the past six months, I definitely haven't figured out the best Django deployment strategy, but I've come a long way. The following is all set up on a <a href="https://www.linode.com/">linode</a> running Ubuntu 12.04.5 LTS.
There are a few key considerations to the setup of hedonometer.org:</p>
<ol>
<li>We're using a virtual machine for full control over the server</li>
<li><a href="https://www.djangoproject.com/">Django</a>, because it's a python MVC framework and has good templating</li>
<li>Data files stored statically for visualizations (asynchronous loads)</li>
<li><a href="http://d3js.org/">d3</a> for the data visualization</li>
</ol>
<h2>Evolution of the server</h2>
<p>At first, the whole thing was running off of the django development server, directly through nginx.
This lasted a long time.
To edit code on the server...it was edited live, through emacs (requiring root acess and port 22 open (at least only ssh keys)) and the django development server was restarted to show changes.
Static files we're collected, they were just edited in place, since this created another step in the way of editing.
Everything for the app was in <code>/usr/share/nginx/wiki/mysite</code> due to some terrible folder creation.</p>
<div class="highlight"><pre><span></span>hedonometer.org -&gt; nginx -&gt; django
</pre></div>


<p>Too many times the site went down due to typos while editing, so I moved to having two separate folders, one served by nginx through dev.hedonometer.org, and the production through hedonometer.org.
This worked well enough, but the code was still edited on the server, in place, and the security was still lacking.
The files were now separated out in <code>/usr/share/nginx/dev</code>, <code>/usr/share/nginx/prod</code>, <code>/usr/share/nginx/data</code>.</p>
<div class="highlight"><pre><span></span>hedonometer.org -&gt; nginx -&gt; django
dev.hedonometer.org -&gt; nginx -&gt; django
hedonometer.org/data -&gt; nginx -&gt; /usr/share/nginx/data
</pre></div>


<p>Then along came uWSGI. This got us away from the django development server, a good step forward...but we were just running two uwsgi servers from root.</p>
<div class="highlight"><pre><span></span>hedonometer.org -&gt; nginx -&gt; uwsgi -&gt; django
dev.hedonometer.org -&gt; nginx -&gt; uwsgi -&gt; django
hedonometer.org/data -&gt; nginx -&gt; /usr/share/nginx/data
</pre></div>


<p>With a great leap, I spawned uWSGI in emporer mode, created user accounts with empty git repositories for each version of the site, and could push the site up through git, where uwsgi would restart with post commit hook, static files would be collected, etc.
The user accounts were <code>prod</code> and <code>dev</code>, so the site was hosted in <code>/home/prod/hedonometer</code> and <code>/home/dev/hedonometer</code>.
Getting a local version running with mysql on the mac was a pain, but then I could actually run the site locally.
And things were better.
Since most of the data is loaded from static data files, I started using full URL paths for the data.</p>
<p>And that leaves us at now.
A final upgrade removed all of the private settings in python files, and moved them all to the environment...so that the whole project could be shared on <a href="https://github.com/andyreagan/hedonometer">github</a>.</p>
<h2>Setting up this strategy</h2>
<p>First, rip through the <a href="https://www.linode.com/docs/security/securing-your-server">security guide</a> from linode. By that, I mean take a good couple days.
Then:</p>
<ol>
<li><a href="https://www.linode.com/docs/websites/nginx/websites-with-nginx-on-ubuntu-12-04-lts-precise-pangolin">Set up nginx</a></li>
<li><a href="https://www.linode.com/docs/databases/mysql/using-mysql-relational-databases-on-ubuntu-12-04-lts-precise-pangolin">Get mysql running</a></li>
</ol>
<p>Basically, we're going to create a user account, some settings for uwsgi and nginx to serve this account, and start the bare git repository that will be used to host it.
I've pulled these settings together from a lot of different places, mainly the docs for each service, and I also want to acknowledge that I found a <a href="http://bradenmacdonald.com/blog/2013/hosting-django-apps-ubuntu-nginx-uwsgi">blog post by Braden MacDonald</a> that has a very similar strategy.
All of this can be accomplised with a long bash script, which I'll post someday, and here is the blow by blow:</p>
<p>Since you followed the linode security guide, log in to your user account on the linode. For me, this is <code>user0</code>.</p>
<div class="highlight"><pre><span></span>ssh user0@hedonometer.org
su root
</pre></div>


<p>We're going to create an app called <code>storybreaker</code>, and serve it at <code>storybreaker.hedonometer.org</code>. First, make it a database:</p>
<div class="highlight"><pre><span></span>echo &quot;create database storybreaker&quot; | mysql --user=root --password=<span class="cp">${</span><span class="n">DJ_DB_PASSWORD</span><span class="cp">}</span>
</pre></div>


<p>Create a user account:</p>
<div class="highlight"><pre><span></span>useradd -d /home/storybreaker -G www-data -m -U -s /bin/bash storybreaker
</pre></div>


<p>Log into that user account and make the git repo.</p>
<div class="highlight"><pre><span></span>su storybreaker <span class="c1"># log in as storybreaker</span>
<span class="nb">cd</span>
mkdir .ssh <span class="o">&amp;&amp;</span> chmod <span class="m">700</span> .ssh <span class="o">&amp;&amp;</span> touch .ssh/authorized_keys
mkdir <span class="nv">$USER</span>.git
<span class="nb">cd</span> <span class="nv">$USER</span>.git
git init --bare
<span class="nb">cd</span> ..
mkdir storybreaker
mkdir uwsgi
</pre></div>


<p>Now, while you're in as <code>storybreaker</code>, edit the post recieve hook in <code>~/storybreaker.git/hooks/post-recieve</code> to do some stuff:</p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="nb">export</span> <span class="nv">GIT_WORK_TREE</span><span class="o">=</span>/home/storybreaker/storybreaker
git checkout -f

python /home/storybreaker/storybreaker/manage.py collectstatic --noinput

<span class="nb">cd</span> ~/uwsgi
cp config<span class="o">{</span>.base,.tmp<span class="o">}</span>
<span class="nb">echo</span> <span class="s2">&quot;env = DJ_SECRET_KEY=</span><span class="si">${</span><span class="nv">DJ_SECRET_KEY</span><span class="si">}</span><span class="s2">&quot;</span> &gt;&gt; config.tmp
<span class="nb">echo</span> <span class="s2">&quot;env = DJ_DEBUG=</span><span class="si">${</span><span class="nv">DJ_DEBUG</span><span class="si">}</span><span class="s2">&quot;</span> &gt;&gt; config.tmp
<span class="nb">echo</span> <span class="s2">&quot;env = DJ_DB_ENGINE=</span><span class="si">${</span><span class="nv">DJ_DB_ENGINE</span><span class="si">}</span><span class="s2">&quot;</span> &gt;&gt; config.tmp
<span class="nb">echo</span> <span class="s2">&quot;env = DJ_DB_NAME=</span><span class="si">${</span><span class="nv">DJ_DB_NAME</span><span class="si">}</span><span class="s2">&quot;</span> &gt;&gt; config.tmp
<span class="nb">echo</span> <span class="s2">&quot;env = DJ_DB_USER=</span><span class="si">${</span><span class="nv">DJ_DB_USER</span><span class="si">}</span><span class="s2">&quot;</span> &gt;&gt; config.tmp
<span class="nb">echo</span> <span class="s2">&quot;env = DJ_DB_PASSWORD=</span><span class="si">${</span><span class="nv">DJ_DB_PASSWORD</span><span class="si">}</span><span class="s2">&quot;</span> &gt;&gt; config.tmp
<span class="nb">echo</span> <span class="s2">&quot;env = DJ_DB_HOST=</span><span class="si">${</span><span class="nv">DJ_DB_HOST</span><span class="si">}</span><span class="s2">&quot;</span> &gt;&gt; config.tmp
<span class="nb">echo</span> <span class="s2">&quot;env = DJ_DB_PORT=</span><span class="si">${</span><span class="nv">DJ_DB_PORT</span><span class="si">}</span><span class="s2">&quot;</span> &gt;&gt; config.tmp
<span class="nb">echo</span> <span class="s2">&quot;env = DJ_STATIC_ROOT=</span><span class="si">${</span><span class="nv">DJ_STATIC_ROOT</span><span class="si">}</span><span class="s2">&quot;</span> &gt;&gt; config.tmp
cp config<span class="o">{</span>.tmp,<span class="o">}</span>
</pre></div>


<p>where the <code>~/uwsgi/config.base</code> looks like:</p>
<div class="highlight"><pre><span></span><span class="o">[</span>uwsgi<span class="o">]</span>

<span class="c1"># setting from braden</span>
<span class="nv">socket</span> <span class="o">=</span> /home/storybreaker/uwsgi/socket
chmod-socket <span class="o">=</span> <span class="m">666</span>
<span class="nv">master</span> <span class="o">=</span> <span class="nb">true</span>
<span class="nv">processes</span> <span class="o">=</span> <span class="m">10</span>

<span class="c1"># for python</span>
<span class="nv">virtualenv</span> <span class="o">=</span> /home/storybreaker/storybreaker/pyenv
<span class="nv">pythonpath</span> <span class="o">=</span> /home/storybreaker/storybreaker
<span class="nv">module</span> <span class="o">=</span> mysite.wsgi

<span class="nv">pidfile2</span> <span class="o">=</span> /home/storybreaker/uwsgi/pid
<span class="nv">daemonize</span> <span class="o">=</span> /home/storybreaker/uwsgi/log
</pre></div>


<p>Make sure to get a newline at the end of the <code>config.base</code>.</p>
<p>And the <code>.env</code> file storying the settings for the app looks like (make sure this is sourced in <code>~/.bashrc</code>:</p>
<div class="highlight"><pre><span></span><span class="c1"># /home/storybreaker/.env</span>
<span class="nb">export</span> <span class="nv">DJ_SECRET_KEY</span><span class="o">=</span><span class="s2">&quot;not telling&quot;</span>
<span class="nb">export</span> <span class="nv">DJ_DEBUG</span><span class="o">=</span>FALSE
<span class="nb">export</span> <span class="nv">DJ_DB_ENGINE</span><span class="o">=</span>django.db.backends.mysql
<span class="nb">export</span> <span class="nv">DJ_DB_NAME</span><span class="o">=</span>storybreaker
<span class="nb">export</span> <span class="nv">DJ_DB_USER</span><span class="o">=</span>root
<span class="nb">export</span> <span class="nv">DJ_DB_PASSWORD</span><span class="o">=</span><span class="s2">&quot;not telling either&quot;</span>
<span class="nb">export</span> <span class="nv">DJ_DB_HOST</span><span class="o">=</span><span class="m">127</span>.0.0.1
<span class="nb">export</span> <span class="nv">DJ_DB_PORT</span><span class="o">=</span><span class="m">3306</span>
<span class="nb">export</span> <span class="nv">DJ_STATIC_ROOT</span><span class="o">=</span>/home/storybreaker/storybreaker/mysite/static
</pre></div>


<p>So now you can see what the post recieve hook does: copy over the files, collect static, and make a new config file for uWSGI.
Once this new config file is copied over, the server will restart, because we're about to link to it the folder that the uWSGI emporer is watching.</p>
<p>Copy over the ssh keys to their account:</p>
<div class="highlight"><pre><span></span>cat ~/.ssh/authorized_keys &gt;&gt; /home/storybreaker/.ssh/authorized_keys
</pre></div>


<p>Now is a good time to push up the app, test the database connection, and install the requirements in the <code>virtualenv</code>.
To push from the local repo:</p>
<div class="highlight"><pre><span></span><span class="c1"># locally</span>
git remote add linode storybreaker@hedonometer.org:storybreaker.git
git push linode master
</pre></div>


<p>I store the requirements in a file called <code>requirements.txt</code>, and so setting up from here (under the storybreaker user) looks like:</p>
<div class="highlight"><pre><span></span><span class="c1"># as storybreaker</span>
env <span class="c1"># check the the DJ_ settings are in the environment</span>
<span class="nb">cd</span> ~/storybreaker
./manage.py dbshell <span class="c1"># make sure we can log into the db</span>
./manage.py collectstatic <span class="c1"># check static file collection</span>
virtualenv pyenv <span class="c1"># set up virtualenv</span>
. pyenv/bin/activate
pip install -r requirements.txt
</pre></div>


<p>Now, if everything worked, we just need to create and link a nginx configuration, and link the uwsgi configuration.
The nginx config file:</p>
<div class="highlight"><pre><span></span><span class="c1"># the upstream component nginx needs to connect to</span>
upstream storybreaker <span class="o">{</span>
    server unix:///home/storybreaker/uwsgi/socket<span class="p">;</span> <span class="c1"># for a file socket</span>
<span class="o">}</span>

<span class="c1"># configuration of the server</span>
server <span class="o">{</span>
    <span class="c1"># the port your site will be served on</span>
    listen      <span class="m">80</span><span class="p">;</span>
    <span class="c1"># the domain name it will serve for</span>
    server_name storybreaker.hedonometer.org<span class="p">;</span>
    charset     utf-8<span class="p">;</span>

    <span class="c1"># max upload size</span>
    client_max_body_size 75M<span class="p">;</span>   <span class="c1"># adjust to taste</span>
    <span class="c1"># set this for local development</span>
    <span class="c1"># add_header &#39;Access-Control-Allow-Origin&#39; &#39;http://127.0.0.1:54043&#39;;</span>

    rewrite  ^/<span class="o">(</span><span class="se">\?</span>.*<span class="o">)</span>?$  /index.html<span class="nv">$1</span>  permanent<span class="p">;</span>

    location /static <span class="o">{</span>
        autoindex on<span class="p">;</span>
        <span class="nb">alias</span> /home/storybreaker/storybreaker/mysite/static<span class="p">;</span> <span class="c1"># your Django project&#39;s static files - amend as required</span>
    <span class="o">}</span>

    location /data <span class="o">{</span>
        autoindex on<span class="p">;</span>
        <span class="nb">alias</span> /usr/share/nginx/data<span class="p">;</span> <span class="c1"># your Django project&#39;s static files - amend as required</span>
    <span class="o">}</span>

    <span class="c1"># Finally, send all non-media requests to the Django server.</span>
    location / <span class="o">{</span>
        uwsgi_pass storybreaker<span class="p">;</span>
        include /home/storybreaker/uwsgi_params<span class="p">;</span> <span class="c1"># the uwsgi_params file you installed</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># link this config</span>
ln -s /home/storybreaker/nginx.conf /etc/nginx/sites-enabled/storybreaker
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># from root, copy over this file we made</span>
mv /home/panometer/uwsgi/config /etc/uwsgi/panometer.ini
<span class="c1"># double check that they own this</span>
chown storbreaker:www-data /etc/uwsgi/panometer.ini
<span class="c1"># as panometer, make a link</span>
su panometer
ln -s /etc/uwsgi/panometer.ini ~/uwsgi/config
</pre></div>


<p>Finally, just restart nginx and it should be working!</p>
<div class="highlight"><pre><span></span>nginx -s reload
</pre></div>


<h2>Things I'm looking to do</h2>
<p>To avoid duplicating, there are a whole host of issues that I still have, and I've posted them on the github repository: <a href="https://github.com/andyreagan/hedonometer/issues">https://github.com/andyreagan/hedonometer/issues</a>.</p>
  </div><!-- /.entry-content -->
      </div>
      </div>      
 </section><!-- /#content -->

    <footer id="slidingfooter" class="body">
      Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>. Site design by Andy Reagan.
    </footer><!-- /#contentinfo -->
  </body>
</script>
</html>